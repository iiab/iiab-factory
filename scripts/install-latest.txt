#!/bin/bash -x -e
# This script was obtained from: http://github.com/jvonau/iiab-factory/install-latest.txt

IIAB_RELEASE="master"
ADMIN_RELEASE="master"
CONF_FILE=/etc/iiab/local_vars.yml
BASE=/opt/iiab
REINSTALL=""
SUPPORT=""
FLAGS=$BASE/iiab-factory/flags
set -e                                   # Exit on error (avoids snowballing)
export DEBIAN_FRONTEND=noninteractive    # Bypass (most!) interactive questions

if [ "$(grep '^pi:' /etc/shadow | cut -d: -f2)" == '$6$D12eVhKX$00kKcOd8ExXk0ZruVWRQnukJi4CEW7Jg7DAgf3E6umxe4PQn7ac4X4TobozWbBIthsUM26EA7ZY4Ypvv63H121' ]; then
    echo -e "\n\nRaspberry Pi's are COMPROMISED often if the default password is not changed!\n"
    echo -n "What password do you want for GNU/Linux user 'pi' ? "
    read pass < /dev/tty
    echo pi:"$pass" | chpasswd
fi

if [ "$1" = "--reinstall" ]; then
    rm $FLAGS/*
    REINSTALL="--reinstall"
fi

mkdir -p /etc/iiab
if [ -f $BASE/iiab/vars/local_vars.yml ]; then
    # FUTURE: Test if their local_vars.yml is sufficiently version-compatible !
    echo -e "\n\n  EXISTING $BASE/iiab/vars/local_vars.yml will be moved to reinstall Internet-in-a-Box\n"
    mv $BASE/iiab/vars/local_vars.yml /etc/iiab/local_vars.yml
    REINSTALL="--reinstall"
elif [ -f /etc/iiab/local_vars.yml ]; then
    # FUTURE: Test if their local_vars.yml is sufficiently version-compatible !
    echo -e "\n\n  EXISTING /etc/iiab/local_vars.yml will be used to install Internet-in-a-Box\n"
    echo -e "   🚂 🚃 🚄 🚅 🚆 🚇 🚈 🚉 🚊 🚋 🚌 🚍 🚎 🚏 🚐 🚑 🚒 🚚 🚛 🚜 🚞 🚟 🚠 🚡 🚲\n"
    echo -e "             See http://wiki.iiab.io/local_vars.yml to learn more!\n"
else
    echo -e "\nInstalling Internet-in-a-Box requires /etc/iiab/local_vars.yml"
    echo -e "PLEASE SEE http://wiki.iiab.io/local_vars.yml TO LEARN MORE!\n"

    echo -e "Do you want (1) 🚵 MIN-sized (2) 🚢🚣 MEDIUM-sized or (3) 🚂🚃🚃 BIG-sized?"

    echo -e "\nThese generally take about 1, 2 or 3 hours to complete -- depending"
    echo -e "on Internet speed, CPU speed/temperature and microSD card/disk speed.\n"

    echo -e "IN FUTURE: you might choose to pre-position your own customized"
    echo -e "/etc/iiab/local_vars.yml prior to running this script.\n"

    echo -n "Please type 1, 2 or 3 then press [ENTER]: "
    read -t 5 local_vars_size < /dev/tty || true
    echo
fi

echo -e "Do you want to enable vpn support?"
echo -n "Please type y/n then press [ENTER]: "
read -t 5 vpn < /dev/tty || true
if [ "$vpn" == "y" ]; then
    SUPPORT="_vpn"
    echo -e "vpn support selected"
else
    echo -e "vpn support NOT selected"
fi

echo -en "\nEdit /etc/iiab/local_vars.yml later in the install to customize your Internet-in-a-Box? [Y/n] "
read -t 5 nano < /dev/tty || true

# this should be in iiab 1-prep somewhere
if grep -qi raspbian /etc/*release; then tune2fs -m 1 /dev/mmcblk0p2; fi
# If OS is Raspbian, lowers reserve disk space from ~5% to 1%

echo -e "\n\n'apt update' is checking for OS updates...\n"
apt -qq update > /tmp/apt.stdout 2> /tmp/apt.stderr || true    # Overrides 'set -e'
if [ $(wc -c < /tmp/apt.stderr) -gt 82 ]; then    # apt.stderr typically contains exactly 82 characters when there are no errors, i.e. 3-line file "\nWARNING: apt does not have a stable CLI interface. Use with caution in scripts.\n\n" _OR_ in other cases more than 82, e.g. many lines of errors when apt is busy/locked/offline/etc
    echo -e "'apt update' FAILED. VERIFY YOU'RE ONLINE and resolve all errors below:\n"
    cat /tmp/apt.stderr
    exit 1
fi
echo -e "Installing git & nano"
apt -y install git nano

mkdir -p $BASE
cd $BASE/

if [ -d iiab-factory ]; then
    echo -e 'iiab-factory auto update'
    cd $BASE/iiab-factory/
    git pull origin master
else
#    git clone https://github.com/iiab/iiab-factory --depth 1
    git clone https://github.com/jvonau/iiab-factory --depth 1
    ln -fs $BASE/iiab-factory/scripts/install-latest.txt /usr/bin/iiab
    echo -e "\n\n ██████████████████████████████████████████████████████████████████████████████"
    echo -e " ██                                                                          ██"
    echo -e " ██  RUN 'sudo iiab' IF THIS INSTALL SCRIPT EVER FAILS, TO TRY TO CONTINUE!  ██"
    echo -e " ██                                                                          ██"
    echo -e " ██████████████████████████████████████████████████████████████████████████████"
fi

# replace with ansible role WIP
cp -f $BASE/iiab-factory/roles/iiab-installer/files/iiab-installer.service /etc/systemd/system/
#systemctl enable iiab-installer

cd $BASE/
if [ -d iiab ]; then
    echo -e 'iiab auto update'
    cd $BASE/iiab
    git pull origin $IIAB_RELEASE
    if [ "$SUPPORT"="_vpn" ]: then
        sed -i -e "s/openvpn_install: False/openvpn_install: True/" /etc/iiab/local_vars.yml
        sed -i -e "s/openvpn_enabled: False/openvpn_enabled: True/" /etc/iiab/local_vars.yml
    fi
else
    git clone https://github.com/iiab/iiab --branch $IIAB_RELEASE --depth 1
    if [ ! -f /etc/iiab/local_vars.yml ]; then
        cd $BASE/iiab
        case $local_vars_size in
            1)
            cp vars/local_vars_min$SUPPORT.yml /etc/iiab/local_vars.yml
                ;;
            3)
            cp vars/local_vars_big$SUPPORT.yml /etc/iiab/local_vars.yml
                ;;
            *)
            cp vars/local_vars_medium$SUPPORT.yml /etc/iiab/local_vars.yml
                ;;
        esac
    fi
fi

# Clones Admin Console
cd $BASE
if [ -d iiab-admin-console ]; then
    echo -e 'iiab-admin-console auto update'
    cd $BASE/iiab-admin-console/
    git pull origin $ADMIN_RELEASE
else
    git clone https://github.com/iiab/iiab-admin-console --branch $ADMIN_RELEASE --depth 1
fi

# Clones Dynamic Menuing for /library/www/html/home/index.html
if [ -d iiab-menu ]; then
    echo -e '\nREPO EXISTS? Consider "cd $BASE/iiab-menu; git pull; ./cp-menus"'
else
    git clone https://github.com/iiab/iiab-menu --depth 1
fi

if [ "$nano" == "y" ] || [ "$nano" == "Y" ]; then
    nano /etc/iiab/local_vars.yml
fi

touch $FLAGS/clone-complete

# Installs latest Ansible-2.6.x from PPA.
$BASE/iiab-factory/scripts/ansible-2.6.x


if [ $(wc -c < /tmp/apt.stdout) -gt 29 ]; then    # apt.stdout typically contains either 29 characters, i.e. 1-line file "All packages are up to date.\n" _OR_ in other cases more than 29, e.g. "5 packages can be upgraded. Run 'apt list --upgradable' to see them.\n"
    cat /tmp/apt.stdout
    echo -e "\nYour OS will now be upgraded...this takes time. THEN IT WILL AUTO-REBOOT.\n"

    echo -n "Hit [ENTER] to confirm you'll RUN 'sudo iiab' AFTER IT REBOOTS: "
    read ans < /dev/tty
    echo
    apt -y dist-upgrade
    reboot
fi

# If we didn't reboot just continue with the rest of the install
$BASE/iiab-factory/scripts/continue.sh $REINSTALL
