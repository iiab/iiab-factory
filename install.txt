#!/bin/bash
# Copied from: https://github.com/jvonau/iiab-factory/blob/pi-gen/install.txt
set -e                                   # Exit on error (avoids snowballing)
export DEBIAN_FRONTEND=noninteractive    # Bypass (most!) interactive questions
BASE=/opt/iiab

echo -e "\n\nDOWNLOAD (CLONE) IIAB'S 3 KEY REPOS INTO $BASE ...\n"
apt -y install git nano
mkdir -p $BASE
cd $BASE
echo
if [ -d iiab-factory ]; then
    echo -e "REPO iiab-factory EXISTS? -- updating master branch"
    cd iiab-factory
    git checkout master
    git pull
    git branch -D jv-pi-gen || true #remove for production
    git checkout -b jv-pi-gen #remove for production
    git pull https://github.com/jvonau/iiab-factory.git pi-gen #remove for production
    ln -sf /opt/iiab/iiab-factory/iiab /usr/sbin/iiab
else
    echo -e "Cloning iiab-factory"
#    git clone https://github.com/iiab/iiab-factory --depth 1 # for production
    git clone https://github.com/iiab/iiab-factory #remove for production
    cd iiab-factory
    git checkout -b jv-pi-gen #remove for production
    git pull https://github.com/jvonau/iiab-factory.git pi-gen #remove for production
    ln -sf /opt/iiab/iiab-factory/iiab /usr/sbin/iiab
fi
cd $BASE
echo
if [ -d iiab ]; then
    echo -e "REPO iiab EXISTS? Consider 'sudo iiab --reinstall'"
else
    git clone https://github.com/iiab/iiab --depth 10 --branch release-7.0
    git checkout -b master
    git config branch.master.remote origin
    git config branch.master.merge refs/heads/master
    git checkout release-7.0
    git checkout -b jv-pi-gen #remove for production
    git pull https://github.com/jvonau/iiab.git pi-gen #remove for production
fi
cd $BASE
echo
if [ -d iiab-admin-console ]; then
    echo -e "REPO iiab-admin-console EXISTS? Consider 'sudo iiab --reinstall'"
else
    git clone https://github.com/iiab/iiab-admin-console --depth 1 --branch v0.3.7
    git checkout -b master
    git config branch.master.remote origin
    git config branch.master.merge refs/heads/master
    git checkout v0.3.7
fi

# Run install script!
/usr/sbin/iiab
