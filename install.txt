#!/bin/bash -x

# Installs IIAB - if Ubuntu or Debian, run "sudo su -" then SKIP TO STEP 4

# 1. RUN "sudo su -" then "passwd pi" to SECURE published password
# 2. RUN "raspi-config" to set LOCALISATION OPTIONS
# 3. RUN "touch /boot/ssh" to enable incoming SSH after next reboot
# 4. RUN "apt update; apt -y dist-upgrade; reboot" for OS SECURITY/UPDATES
# 5. OPTIONAL: if you have slow/pricey Internet, pre-position KA Lite's
#    mandatory 0.9 GB English Pack (en.zip) within /tmp -- if nec grab a copy
#    from http://pantry.learningequality.org/downloads/ka-lite/0.17/content/contentpacks/en.zip
# 6. RUN THIS SCRIPT: curl download.iiab.io/6.6/install.txt | sudo bash
# 7. REBOOTS AUTOMATICALLY WHEN DONE (typically 1-to-3 hours later)
#    which sets the hostname, improves RTC settings + memory mgmt

# This script was obtained from: http://download.iiab.io/6.6/install.txt
#IIAB_RELEASE="6.6-release"
IIAB_RELEASE="master"
ADMIN_RELEASE="master"
REINSTALL=""
set -e                                   # Exit on error (avoids snowballing)
export DEBIAN_FRONTEND=noninteractive    # Bypass (most!) interactive questions
echo -e "\n   █████████████████████████████████████████████████████████████████████████"
echo -e "   ██ TRY TO RERUN THIS ENTIRE SCRIPT IF IT FAILS DUE TO CONNECTIVITY ETC ██"
echo -e "   █████████████████████████████████████████████████████████████████████████\n\n"

mkdir -p /etc/iiab
cd /etc/iiab/

if [ -f /opt/iiab/iiab/vars/local_vars.yml ]; then
    # FUTURE: Test if their local_vars.yml is sufficiently version-compatible !
    echo -e "\n\n  EXISTING /opt/iiab/iiab/vars/local_vars.yml will be used to reinstall Internet-in-a-Box\n"
    cp /opt/iiab/iiab/vars/local_vars.yml /etc/iiab/local_vars.yml
    REINSTALL="--reinstall"
fi

if [ -f /etc/iiab/local_vars.yml ]; then
    # FUTURE: Test if their local_vars.yml is sufficiently version-compatible !

    echo -e "\n\n  EXISTING /etc/iiab/local_vars.yml will be used to install Internet-in-a-Box\n"
    echo -e "   🚂 🚃 🚄 🚅 🚆 🚇 🚈 🚉 🚊 🚋 🚌 🚍 🚎 🚏 🚐 🚑 🚒 🚚 🚛 🚜 🚞 🚟 🚠 🚡 🚲\n"
    echo -e "             See http://wiki.iiab.io/local_vars.yml to learn more!\n"
else
    echo -e "\nInstalling Internet-in-a-Box requires /etc/iiab/local_vars.yml"
    echo -e "PLEASE SEE http://wiki.iiab.io/local_vars.yml TO LEARN MORE!\n"

    echo -e "Do you want (1) 🚵 MIN-sized (2) 🚢🚣 MEDIUM-sized or (3) 🚂🚃🚃 BIG-sized?"

    echo -e "\nThese generally take about 1, 2 or 3 hours to complete -- depending"
    echo -e "on Internet speed, CPU speed/temperature and microSD card/disk speed.\n"

    echo -e "IN FUTURE: you might choose to pre-position your own customized"
    echo -e "/etc/iiab/local_vars.yml prior to running this script.\n"

    echo -n "Please type 1, 2 or 3 then press [ENTER]: "
    read local_vars_size < /dev/tty
    echo

    case $local_vars_size in
        1)
	    wget -O local_vars.yml https://github.com/iiab/iiab/raw/master/vars/local_vars_min.yml
	    ;;
	3)
	    wget -O local_vars.yml https://github.com/iiab/iiab/raw/master/vars/local_vars_big.yml
	    ;;
	*)
	    wget -O local_vars.yml https://github.com/iiab/iiab/raw/master/vars/local_vars_medium.yml
	    ;;
    esac
fi

if grep -qi raspbian /etc/*release; then tune2fs -m 1 /dev/mmcblk0p2; fi
# If OS is Raspbian, lowers reserve disk space from ~5% to 1%

apt update
apt -y install git

mkdir -p /opt/iiab
cd /opt/iiab/
if [ -d iiab ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab; git pull"'
    echo -e 'auto update'
    git pull origin $RELEASE
else
    git clone https://github.com/iiab/iiab --branch $RELEASE --depth 1
fi
if [ -d iiab-admin-console ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab-admin-console; git pull"'
    echo -e 'auto update'
    git pull origin $RELEASE
else
    git clone https://github.com/iiab/iiab-admin-console --branch $RELEASE --depth 1
fi
if [ -d iiab-menu ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab-menu; git pull"'
else
    git clone https://github.com/iiab/iiab-menu --depth 1
fi
if [ -d iiab-factory ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab-factory; git pull"'
else
    git clone https://github.com/iiab/iiab-factory --depth 1
fi

cd /opt/iiab/iiab/scripts/
./ansible
# Installs latest Ansible from PPA.  Also consider: ./ansible-2.6.x

cd /opt/iiab/iiab/
./iiab-install $REINSTALL
# TRY TO RERUN THE ABOVE LINE IF IT FAILS (if networking glitches etc?)

cd /opt/iiab/iiab-admin-console/
./install
# Installs Admin Console; runs iiab-get-kiwix-cat to d/l Kiwix catalog

cd /opt/iiab/iiab-menu/
./cp-menus
# Installs Dynamic Menuing for /library/www/html/home/index.html

iiab-make-kiwix-lib
# Rebuilds local library.xml in case ZIM files added to /library/zims/content

# /usr/bin/kalite venv wrapper does this: export KALITE_HOME=/library/ka-lite
kalite manage generate_zone || true    # Overrides "set -e" allowing repeat run
# Register with KA Lite - just the anonymous registration

cd /tmp/    # Or /opt/iiab/downloads or /library/downloads if you prefer
if [ -f en.zip ]; then
    if [ $(wc -c < en.zip) -ne 929916955 ]; then
        echo -e "\nERROR: /tmp/en.zip must be 929,916,955 bytes to proceed.\n" >&2
        exit 1
    else
	echo -e "\nUsing existing /tmp/en.zip whose 929,916,955 byte size is correct!\n"
    fi
else
    wget http://pantry.learningequality.org/downloads/ka-lite/0.17/content/contentpacks/en.zip
fi
kalite manage retrievecontentpack local en en.zip
# WARNING: /tmp/en.zip (and all stuff in /tmp) is auto-deleted during reboots
# NEW WAY ABOVE - since 2018-07-03 - installs KA Lite's mandatory English Pack

# kalite manage retrievecontentpack download en
# OLD WAY ABOVE - fails w/ sev ISPs per https://github.com/iiab/iiab/issues/871

echo -e "\n\nINTERNET-IN-A-BOX (IIAB) SOFTWARE INSTALL COMPLETE...now rebooting.\n"
echo -e "A couple minutes after reboot, try connecting to your IIAB with various"
echo -e "devices, and then browse to IIAB's Admin Console to install content:\n"
echo -e "   http://box/admin"
echo -e "   http://box.lan/admin"
echo -e "   http://172.18.96.1/admin\n"
echo -e "Please read http://FAQ.IIAB.IO for default passwords and more!\n"

reboot
