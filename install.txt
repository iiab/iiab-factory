#!/bin/bash -x

# Installs IIAB - if Ubuntu or Debian, run "sudo su -" then SKIP TO STEP 4

# 1. RUN "sudo su -" then "passwd pi" to SECURE published password
# 2. RUN "raspi-config" to set LOCALISATION OPTIONS
# 3. RUN "touch /boot/ssh" to enable incoming SSH after next reboot
# 4. RUN "apt update; apt -y dist-upgrade; reboot" for OS SECURITY/UPDATES
# 5. OPTIONAL: if you have slow/pricey Internet, pre-position KA Lite's
#    mandatory 0.9 GB English Pack (en.zip) within /tmp -- if nec grab a copy
#    from http://pantry.learningequality.org/downloads/ka-lite/0.17/content/contentpacks/en.zip
# 6. RUN THIS SCRIPT: curl download.iiab.io/6.6/install.txt | sudo bash
# 7. REBOOTS AUTOMATICALLY WHEN DONE (typically 1-to-3 hours later)
#    which sets the hostname, improves RTC settings + memory mgmt

# This script was obtained from: http://download.iiab.io/6.6/install.txt
#IIAB_RELEASE="6.6-release"
IIAB_RELEASE="master"
ADMIN_RELEASE="master"
REINSTALL=""
set -e                                   # Exit on error (avoids snowballing)
export DEBIAN_FRONTEND=noninteractive    # Bypass (most!) interactive questions
echo -e "\n   █████████████████████████████████████████████████████████████████████████"
echo -e "   ██ TRY TO RERUN THIS ENTIRE SCRIPT IF IT FAILS DUE TO CONNECTIVITY ETC ██"
echo -e "   █████████████████████████████████████████████████████████████████████████\n\n"

mkdir -p /etc/iiab
if [ -f /opt/iiab/iiab/vars/local_vars.yml ]; then
    # FUTURE: Test if their local_vars.yml is sufficiently version-compatible !
    echo -e "\n\n  EXISTING /opt/iiab/iiab/vars/local_vars.yml will be moved to reinstall Internet-in-a-Box\n"
    mv /opt/iiab/iiab/vars/local_vars.yml /etc/iiab/local_vars.yml
    REINSTALL="--reinstall"
elif [ -f /etc/iiab/local_vars.yml ]; then
    # FUTURE: Test if their local_vars.yml is sufficiently version-compatible !
    echo -e "\n\n  EXISTING /etc/iiab/local_vars.yml will be used to install Internet-in-a-Box\n"
    echo -e "   🚂 🚃 🚄 🚅 🚆 🚇 🚈 🚉 🚊 🚋 🚌 🚍 🚎 🚏 🚐 🚑 🚒 🚚 🚛 🚜 🚞 🚟 🚠 🚡 🚲\n"
    echo -e "             See http://wiki.iiab.io/local_vars.yml to learn more!\n"
else
    echo -e "\nInstalling Internet-in-a-Box requires /etc/iiab/local_vars.yml"
    echo -e "PLEASE SEE http://wiki.iiab.io/local_vars.yml TO LEARN MORE!\n"

    echo -e "Do you want (1) 🚵 MIN-sized (2) 🚢🚣 MEDIUM-sized or (3) 🚂🚃🚃 BIG-sized?"

    echo -e "\nThese generally take about 1, 2 or 3 hours to complete -- depending"
    echo -e "on Internet speed, CPU speed/temperature and microSD card/disk speed.\n"

    echo -e "IN FUTURE: you might choose to pre-position your own customized"
    echo -e "/etc/iiab/local_vars.yml prior to running this script.\n"

    echo -n "Please type 1, 2 or 3 then press [ENTER]: "
    read local_vars_size < /dev/tty
    echo
fi

if grep -qi raspbian /etc/*release; then tune2fs -m 1 /dev/mmcblk0p2; fi
# If OS is Raspbian, lowers reserve disk space from ~5% to 1%

apt update
apt -y install git

mkdir -p /opt/iiab
cd /opt/iiab/

# Move parts of this script into factory and call then from there in the future
if [ -d iiab-factory ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab-factory; git pull"'
else
    git clone https://github.com/iiab/iiab-factory --depth 1
fi

if [ -d iiab ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab; git pull"'
    echo -e 'auto update'
    cd /opt/iiab/iiab
    git pull origin $IIAB_RELEASE
else
    git clone https://github.com/iiab/iiab --branch $IIAB_RELEASE --depth 1
    cd /opt/iiab/iiab
    case $local_vars_size in
        1)
	    cp vars/local_vars_min.yml /etc/iiab/local_vars.yml
	    ;;
	3)
	    cp vars/local_vars_big.yml /etc/iiab/local_vars.yml
	    ;;
	2)
	    cp vars/local_vars_medium.yml /etc/iiab/local_vars.yml
	    ;;
    esac
fi

cd /opt/iiab/iiab/scripts/
./ansible
# Installs latest Ansible from PPA.  Also consider: ./ansible-2.6.x
cd /opt/iiab/iiab/
./iiab-install $REINSTALL

# Installs Admin Console; runs iiab-get-kiwix-cat to d/l Kiwix catalog
if [ -d iiab-admin-console ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab-admin-console; git pull"'
    echo -e 'auto update'
    cd /opt/iiab/iiab-admin-console/
    git pull origin $ADMIN_RELEASE
    ./install
else
    git clone https://github.com/iiab/iiab-admin-console --branch $ADMIN_RELEASE --depth 1
    cd /opt/iiab/iiab-admin-console/
    ./install
fi

# Installs Dynamic Menuing for /library/www/html/home/index.html
if [ -d iiab-menu ]; then
    echo -e '\nREPO EXISTS? Consider "cd /opt/iiab/iiab-menu; git pull; ./cp-menus"'
else
    git clone https://github.com/iiab/iiab-menu --depth 1
    cd /opt/iiab/iiab-menu/
    ./cp-menus
fi

cd /opt/iiab/iiab-factory
./post-install

echo -e "\n\nINTERNET-IN-A-BOX (IIAB) SOFTWARE INSTALL COMPLETE...now rebooting.\n"
echo -e "A couple minutes after reboot, try connecting to your IIAB with various"
echo -e "devices, and then browse to IIAB's Admin Console to install content:\n"
echo -e "   http://box/admin"
echo -e "   http://box.lan/admin"
echo -e "   http://172.18.96.1/admin\n"
echo -e "Please read http://FAQ.IIAB.IO for default passwords and more!\n"

reboot
